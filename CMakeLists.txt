cmake_minimum_required(VERSION 3.15)
project(opencv_onnxruntime_project VERSION 1.0.0 LANGUAGES CXX)

# è®¾ç½® C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ç¦ç”¨ OpenCV ä¸­çš„ ITT æ”¯æŒ
add_definitions(-DOPENCV_DISABLE_ITT=1)

# ä½¿ç”¨ Conan ç®¡ç†çš„ OpenCV å’Œ ONNX Runtime
# æ ¹æ®æ„å»ºç±»å‹ä½¿ç”¨å¯¹åº”ç‰ˆæœ¬çš„åº“

# æ ¹æ®æ„å»ºç±»å‹é€‰æ‹©å¯¹åº”çš„ Conan ç”Ÿæˆå™¨
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    set(CONAN_GENERATORS_PATHS
        "${CMAKE_SOURCE_DIR}/build/Debug/generators"
        "${CMAKE_BINARY_DIR}/../Debug/generators"
        "${CMAKE_BINARY_DIR}/generators"
    )
else()
    set(CONAN_GENERATORS_PATHS
        "${CMAKE_SOURCE_DIR}/build/Release/generators"
        "${CMAKE_BINARY_DIR}/../Release/generators"
        "${CMAKE_BINARY_DIR}/generators"
    )
endif()

set(CONAN_GENERATORS_DIR "")
foreach(path ${CONAN_GENERATORS_PATHS})
    if(EXISTS "${path}/cmakedeps_macros.cmake")
        set(CONAN_GENERATORS_DIR ${path})
        message(STATUS "Found Conan generators at: ${path}")
        break()
    endif()
endforeach()

if(CONAN_GENERATORS_DIR STREQUAL "")
    if(CMAKE_BUILD_TYPE STREQUAL "Debug")
        message(FATAL_ERROR "Could not find Conan generators directory. Please run: conan install . --output-folder=build --build=missing -s build_type=Debug")
    else()
        message(FATAL_ERROR "Could not find Conan generators directory. Please run: conan install . --output-folder=build --build=missing -s build_type=Release")
    endif()
endif()

message(STATUS "Using Conan generators from: ${CONAN_GENERATORS_DIR}")
message(STATUS "Program build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Libraries: ${CMAKE_BUILD_TYPE} version")

include(${CONAN_GENERATORS_DIR}/cmakedeps_macros.cmake)
include(${CONAN_GENERATORS_DIR}/conandeps_legacy.cmake)
find_package(opencv REQUIRED)
find_package(onnxruntime REQUIRED)

message(STATUS "Using Conan-managed OpenCV and ONNX Runtime")
message(STATUS "OpenCV target: opencv::opencv")
message(STATUS "ONNX Runtime target: onnxruntime::onnxruntime")

# è®¾ç½®é¡¹ç›®ç›®å½•å˜é‡
set(PROJECT_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/src)
set(PROJECT_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/include)
set(PROJECT_ASSETS_DIR ${CMAKE_CURRENT_SOURCE_DIR}/assets)

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(main ${PROJECT_SOURCE_DIR}/main.cpp)

# è®¾ç½®ç¼–è¯‘é€‰é¡¹ï¼šç¨‹åºå’Œåº“éƒ½ä½¿ç”¨å¯¹åº”çš„æ„å»ºç±»å‹
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    target_compile_definitions(main PRIVATE DEBUG_BUILD=1)
    target_compile_options(main PRIVATE -g -O0 -Wall -Wextra)
    message(STATUS "Building program in DEBUG mode with Debug libraries")
else()
    target_compile_definitions(main PRIVATE RELEASE_BUILD=1)
    target_compile_options(main PRIVATE -O3 -DNDEBUG)
    message(STATUS "Building program in RELEASE mode with Release libraries")
endif()

# é“¾æ¥ Conan ç®¡ç†çš„ä¾èµ–åº“ï¼ˆå§‹ç»ˆä½¿ç”¨ Release ç‰ˆæœ¬ï¼‰
# æ³¨æ„ï¼šç”±äº Conan ç”Ÿæˆå™¨è¡¨è¾¾å¼é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼ºåˆ¶é“¾æ¥ Release ç‰ˆæœ¬çš„åº“
target_link_libraries(main
    opencv::opencv
    onnxruntime::onnxruntime
)

# è°ƒè¯•é“¾æ¥åº“ä¿¡æ¯
get_target_property(MAIN_LINK_LIBS main LINK_LIBRARIES)
message(STATUS "ğŸ”— main ç›®æ ‡é“¾æ¥çš„åº“: ${MAIN_LINK_LIBS}")

# å¼ºåˆ¶æ·»åŠ  Release ç‰ˆæœ¬çš„åº“æ–‡ä»¶ï¼ˆè§£å†³ç”Ÿæˆå™¨è¡¨è¾¾å¼é—®é¢˜ï¼‰
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    message(STATUS "ğŸ”§ Debug æ¨¡å¼ï¼šå¼ºåˆ¶é“¾æ¥ Release ç‰ˆæœ¬çš„åº“æ–‡ä»¶å’Œä¾èµ–")

    # æ‰‹åŠ¨æ·»åŠ  OpenCV åº“æ–‡ä»¶
    find_library(OPENCV_CORE_LIB opencv_core
        PATHS "/home/vscode/.conan2/p/b/openc87b6fbbb87431/p/lib"
        NO_DEFAULT_PATH
    )

    if(OPENCV_CORE_LIB)
        message(STATUS "âœ… æ‰¾åˆ° OpenCV æ ¸å¿ƒåº“: ${OPENCV_CORE_LIB}")
        # æ·»åŠ æ‰€æœ‰ OpenCV åº“
        file(GLOB OPENCV_LIBS "/home/vscode/.conan2/p/b/openc87b6fbbb87431/p/lib/libopencv_*.a")
        target_link_libraries(main ${OPENCV_LIBS})
        message(STATUS "âœ… æ·»åŠ  OpenCV åº“: ${OPENCV_LIBS}")

        # æ·»åŠ  OpenCV ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“
        find_library(ZLIB_LIB z)
        find_library(JPEG_LIB jpeg)
        find_library(PNG_LIB png)
        find_library(TIFF_LIB tiff)

        if(ZLIB_LIB)
            target_link_libraries(main ${ZLIB_LIB})
            message(STATUS "âœ… æ·»åŠ  zlib: ${ZLIB_LIB}")
        endif()

        if(JPEG_LIB)
            target_link_libraries(main ${JPEG_LIB})
            message(STATUS "âœ… æ·»åŠ  libjpeg: ${JPEG_LIB}")
        endif()

        if(PNG_LIB)
            target_link_libraries(main ${PNG_LIB})
            message(STATUS "âœ… æ·»åŠ  libpng: ${PNG_LIB}")
        endif()

        # æ·»åŠ ç³»ç»Ÿåº“
        target_link_libraries(main dl pthread)
        message(STATUS "âœ… æ·»åŠ ç³»ç»Ÿåº“: dl pthread")
    endif()

    # æ‰‹åŠ¨æ·»åŠ  ONNX Runtime åº“æ–‡ä»¶
    find_library(ONNX_SESSION_LIB onnxruntime_session
        PATHS "/home/vscode/.conan2/p/b/onnxr37b44fb2c3935/p/lib"
        NO_DEFAULT_PATH
    )

    if(ONNX_SESSION_LIB)
        message(STATUS "âœ… æ‰¾åˆ° ONNX Runtime åº“: ${ONNX_SESSION_LIB}")
        # æ·»åŠ æ‰€æœ‰ ONNX Runtime åº“
        file(GLOB ONNX_LIBS "/home/vscode/.conan2/p/b/onnxr37b44fb2c3935/p/lib/libonnxruntime_*.a")
        target_link_libraries(main ${ONNX_LIBS})
        message(STATUS "âœ… æ·»åŠ  ONNX Runtime åº“: ${ONNX_LIBS}")
    endif()

    # æ·»åŠ  Conan ç®¡ç†çš„ç¬¬ä¸‰æ–¹åº“
    file(GLOB CONAN_LIBS "/home/vscode/.conan2/p/b/*/p/lib/lib*.a")
    if(CONAN_LIBS)
        target_link_libraries(main ${CONAN_LIBS})
        message(STATUS "âœ… æ·»åŠ  Conan ç¬¬ä¸‰æ–¹åº“: ${CONAN_LIBS}")
    endif()
endif()

# åŒ…å«å¤´æ–‡ä»¶ç›®å½•
target_include_directories(main PRIVATE
    ${PROJECT_INCLUDE_DIR}
)

# è°ƒè¯• Conan ç›®æ ‡å±æ€§
message(STATUS "=== è°ƒè¯• OpenCV ç›®æ ‡å±æ€§ ===")
get_target_property(OPENCV_INCLUDE_DIRS opencv::opencv INTERFACE_INCLUDE_DIRECTORIES)
get_target_property(OPENCV_LINK_LIBS opencv::opencv INTERFACE_LINK_LIBRARIES)
get_target_property(OPENCV_COMPILE_DEFS opencv::opencv INTERFACE_COMPILE_DEFINITIONS)

message(STATUS "OpenCV INTERFACE_INCLUDE_DIRECTORIES: ${OPENCV_INCLUDE_DIRS}")
message(STATUS "OpenCV INTERFACE_LINK_LIBRARIES: ${OPENCV_LINK_LIBS}")
message(STATUS "OpenCV INTERFACE_COMPILE_DEFINITIONS: ${OPENCV_COMPILE_DEFS}")

message(STATUS "=== è°ƒè¯• ONNX Runtime ç›®æ ‡å±æ€§ ===")
get_target_property(ONNX_INCLUDE_DIRS onnxruntime::onnxruntime INTERFACE_INCLUDE_DIRECTORIES)
get_target_property(ONNX_LINK_LIBS onnxruntime::onnxruntime INTERFACE_LINK_LIBRARIES)
get_target_property(ONNX_COMPILE_DEFS onnxruntime::onnxruntime INTERFACE_COMPILE_DEFINITIONS)

message(STATUS "ONNX INTERFACE_INCLUDE_DIRECTORIES: ${ONNX_INCLUDE_DIRS}")
message(STATUS "ONNX INTERFACE_LINK_LIBRARIES: ${ONNX_LINK_LIBS}")
message(STATUS "ONNX INTERFACE_COMPILE_DEFINITIONS: ${ONNX_COMPILE_DEFS}")

# æ‰‹åŠ¨æ·»åŠ å¤´æ–‡ä»¶è·¯å¾„
# è§£å†³ Conan ç”Ÿæˆå™¨è¡¨è¾¾å¼é—®é¢˜ï¼šå¼ºåˆ¶ä½¿ç”¨ Release ç‰ˆæœ¬çš„å¤´æ–‡ä»¶è·¯å¾„

# 1. å¤„ç† OpenCV å¤´æ–‡ä»¶è·¯å¾„
if(OPENCV_INCLUDE_DIRS AND NOT OPENCV_INCLUDE_DIRS STREQUAL "OPENCV_INCLUDE_DIRS-NOTFOUND")
    target_include_directories(main PRIVATE ${OPENCV_INCLUDE_DIRS})
    message(STATUS "âœ… æˆåŠŸæ·»åŠ  OpenCV å¤´æ–‡ä»¶è·¯å¾„: ${OPENCV_INCLUDE_DIRS}")
else()
    message(STATUS "ğŸ” OpenCV ç›®æ ‡æ²¡æœ‰å¤´æ–‡ä»¶è·¯å¾„ï¼Œæ‰‹åŠ¨æŸ¥æ‰¾...")
    # ä» Release ç‰ˆæœ¬çš„ç¼–è¯‘å‘½ä»¤ä¸­æå–çš„å®é™…è·¯å¾„
    set(OPENCV_MANUAL_PATHS
        "/home/vscode/.conan2/p/b/openc4f12223446590/p/include"
        "/home/vscode/.conan2/p/b/openc4f12223446590/p/include/opencv4"
    )

    foreach(path ${OPENCV_MANUAL_PATHS})
        if(EXISTS "${path}/opencv2/opencv.hpp")
            target_include_directories(main PRIVATE ${path})
            message(STATUS "âœ… æ‰‹åŠ¨æ·»åŠ  OpenCV å¤´æ–‡ä»¶è·¯å¾„: ${path}")
            set(OPENCV_FOUND TRUE)
            break()
        endif()
    endforeach()

    if(NOT OPENCV_FOUND)
        message(FATAL_ERROR "âŒ æ— æ³•æ‰¾åˆ° OpenCV å¤´æ–‡ä»¶è·¯å¾„")
    endif()
endif()

# 2. å¤„ç† ONNX Runtime å¤´æ–‡ä»¶è·¯å¾„ï¼ˆè§£å†³ç”Ÿæˆå™¨è¡¨è¾¾å¼é—®é¢˜ï¼‰
message(STATUS "ğŸ” ONNX åŸå§‹è·¯å¾„: ${ONNX_INCLUDE_DIRS}")

# æ‰‹åŠ¨æ·»åŠ  ONNX Runtime å¤´æ–‡ä»¶è·¯å¾„ï¼ˆä»è°ƒè¯•ä¿¡æ¯ä¸­æå–ï¼‰
set(ONNX_MANUAL_PATHS
    "/home/vscode/.conan2/p/b/onnxr1c2c0b60fe458/p/include"
    "/home/vscode/.conan2/p/b/onnxr1c2c0b60fe458/p/include/onnxruntime/core/session"
)

foreach(path ${ONNX_MANUAL_PATHS})
    if(EXISTS ${path})
        target_include_directories(main PRIVATE ${path})
        message(STATUS "âœ… æ‰‹åŠ¨æ·»åŠ  ONNX Runtime å¤´æ–‡ä»¶è·¯å¾„: ${path}")
    endif()
endforeach()

# è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶è¾“å‡ºç›®å½•
set_target_properties(main PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
)

# ç§»é™¤æ‰‹åŠ¨ç¬¬ä¸‰æ–¹åº“è®¾ç½®ï¼Œä¾èµ– Conan ç®¡ç†

# è¾“å‡ºæ„å»ºä¿¡æ¯
message(STATUS "Building OpenCV and ONNX Runtime Project")
message(STATUS "Project version: ${PROJECT_VERSION}")
message(STATUS "Source directory: ${PROJECT_SOURCE_DIR}")
message(STATUS "Include directory: ${PROJECT_INCLUDE_DIR}")
message(STATUS "Assets directory: ${PROJECT_ASSETS_DIR}")
message(STATUS "Using Conan-managed OpenCV and ONNX Runtime dependencies")
